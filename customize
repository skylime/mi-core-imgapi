#!/usr/bin/bash
#
# Put customizations to your image in this file.

# Custom versions and variables
PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin
SDC_IMGAPI_VERSION='master-20170108T160615Z-gee38888'

# Exit if any commands fail
set -o errexit

# Configuring image specific packages
echo "* Download and extract imgapi"
mkdir -p /opt/imgapi
curl http://smartos.skylime.net/extra/imgapi-pkg-${SDC_IMGAPI_VERSION}.tar.bz2 | gtar xj -C /opt/imgapi --strip-components=4

echo "* Extract UI"
curl http://smartos.skylime.net/extra/imgapi-ui-${SDC_IMGAPI_VERSION}.tar.bz2 | gtar xj -C /opt

echo "* Install template config file"
mv /tmp/imgapi.config.tpl /opt/imgapi/etc/

echo "* Chown everything to www user"
chown -R www:www /opt/imgapi

echo "* Import imgapi manifest"
svccfg import /tmp/imgapi.xml
rm /tmp/imgapi.xml

echo "* Create nginx ssl folder"
mkdir -p /opt/local/etc/nginx/ssl

# Clean up
echo "* Cleaning up."
rm -rf /root/*

# Prepare image for provisioning
sm-prepare-image -y
